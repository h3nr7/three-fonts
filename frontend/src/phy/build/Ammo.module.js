const t=new Map,e={Ar:null,ArPos:{},world:null,gravity:null,bodyRef:null,byName:null,delta:0,substep:1,numBreak:0,gravity:null,key:[],reflow:{ray:[],point:{},stat:{fps:0,delta:0}}},s={clear:()=>{t.clear()},byName:e=>t.has(e)?t.get(e):null,add:s=>{if("ray"!==s.type&&"contact"!==s.type)switch(s.type){case"joint":e.world.addConstraint(s,!s.collision);break;case"solid":e.world.addCollisionObject(s,s.group,s.mask);break;case"terrain":e.world.addCollisionObject(s.body,s.group,s.mask);break;case"body":e.world.addRigidBody(s,s.group,s.mask)}t.set(s.name,s)},remove:s=>{if("ray"!==s.type&&"contact"!==s.type)switch(s.type){case"joint":e.world.removeConstraint(s),Ammo.destroy(s.formA),Ammo.destroy(s.formB),Ammo.destroy(s);break;case"solid":e.world.removeCollisionObject(s),Ammo.destroy(s);break;case"body":e.world.removeRigidBody(s),Ammo.destroy(s);break;case"vehicle":case"terrain":s.release()}t.delete(s.name)},getVolume:(t,e,i)=>{let r=1;switch(t){case"sphere":r=4*Math.PI*e[0]*e[0]*e[0]/3;break;case"cone":r=Math.PI*e[0]*(.5*e[1])*2;break;case"box":r=.5*e[0]*8*(.5*e[1])*(.5*e[2]);break;case"cylinder":r=Math.PI*e[0]*e[0]*(.5*e[1])*2;break;case"capsule":r=4*Math.PI*e[0]*e[0]*e[0]/3+Math.PI*e[0]*e[0]*(.5*e[1])*2;break;case"convex":case"mesh":r=s.getConvexVolume(i)}return r},getConvexVolume:t=>{let e,s=t.length/3,i=[t[0],t[1],t[2]],r=[t[0],t[1],t[2]];for(;s--;)e=3*s,t[e]<i[0]?i[0]=t[e]:t[e]>r[0]&&(r[0]=t[e]),t[e+1]<i[1]?i[1]=t[e+1]:t[e+1]>r[1]&&(r[1]=t[e+1]),t[e+2]<i[2]?i[2]=t[e+2]:t[e+2]>r[2]&&(r[2]=t[e+2]);return(r[0]-i[0])*(r[1]-i[1])*(r[2]-i[2])},malloc:(t,e)=>{var s=t.length*t.BYTES_PER_ELEMENT;return void 0===e&&(e=Ammo._malloc(s)),new Uint8Array(Ammo.HEAPU8.buffer,e,s).set(new Uint8Array(t.buffer)),e},free:t=>{t&&Ammo._free(t)},stats:()=>{},extends:()=>{Ammo.btVector3.prototype.set=function(t,e,s){return this.setValue(t,e,s),this},Ammo.btVector3.prototype.toArray=function(t,e){let s=void 0!==t;if(s||(t=[]),t[e=e||0]=this.x(),t[e+1]=this.y(),t[e+2]=this.z(),!s)return t},Ammo.btVector3.prototype.fromArray=function(t,e){return e=e||0,this.setValue(t[e],t[e+1],t[e+2]),this},Ammo.btVector3.prototype.copy=function(t){return this.setValue(t.x(),t.y(),t.z()),this},Ammo.btVector3.prototype.sub=function(t){return this.setValue(this.x()-t.x(),this.y()-t.y(),this.z()-t.z()),this},Ammo.btVector3.prototype.mul=function(){return this.x()*this.y()*this.z()},Ammo.btVector3.prototype.multiplyArray=function(t){return this.setValue(this.x()*t[0],this.y()*t[1],this.z()*t[2]),this},Ammo.btVector3.prototype.multiplyScalar=function(t){return this.setValue(this.x()*t,this.y()*t,this.z()*t),this},Ammo.btVector3.prototype.divideScalar=function(t){return this.multiplyScalar(1/t)},Ammo.btVector3.prototype.applyQuaternion=function(t){const e=this.x(),s=this.y(),i=this.z(),r=t.x(),o=t.y(),a=t.z(),n=t.w(),l=n*e+o*i-a*s,m=n*s+a*e-r*i,h=n*i+r*s-o*e,c=-r*e-o*s-a*i;return this.setValue(l*n+c*-r+m*-a-h*-o,m*n+c*-o+h*-r-l*-a,h*n+c*-a+l*-o-m*-r),this},Ammo.btVector3.prototype.applyMatrix3=function(t){const e=this.x(),s=this.y(),i=this.z(),r=[];return t.getRow(0).toArray(r,0),t.getRow(1).toArray(r,3),t.getRow(2).toArray(r,6),this.setValue(r[0]*e+r[3]*s+r[6]*i,r[1]*e+r[4]*s+r[7]*i,r[2]*e+r[5]*s+r[8]*i),this},Ammo.btVector3.prototype.free=function(){},Ammo.btQuaternion.prototype.set=function(t,e,s,i){return this.setValue(t,e,s,i),this},Ammo.btQuaternion.prototype.toArray=function(t,e){let s=void 0!==t;if(s||(t=[]),t[e=e||0]=this.x(),t[e+1]=this.y(),t[e+2]=this.z(),t[e+3]=this.w(),!s)return t},Ammo.btQuaternion.prototype.fromArray=function(t,e){return e=e||0,this.setValue(t[e],t[e+1],t[e+2],t[e+3]),this},Ammo.btQuaternion.prototype.multiply=function(t){return this.multiplyQuaternions(this,t)},Ammo.btQuaternion.prototype.premultiply=function(t){return this.multiplyQuaternions(t,this)},Ammo.btQuaternion.prototype.multiplyQuaternions=function(t,e){const s=t.x(),i=t.y(),r=t.z(),o=t.w(),a=e.x(),n=e.y(),l=e.z(),m=e.w();return this.setValue(s*m+o*a+i*l-r*n,i*m+o*n+r*a-s*l,r*m+o*l+s*n-i*a,o*m-s*a-i*n-r*l),this},Ammo.btQuaternion.prototype.fromAxisAngle=function(t,e){var s=.5*e,i=Math.sin(s);return this.setValue(t[0]*i,t[1]*i,t[2]*i,Math.cos(s)),this},Ammo.btQuaternion.prototype.fromAxis=function(t){let e=t.toArray();if(e[2]>.99999)this.setValue(0,0,0,1);else if(e[2]<-.99999)this.setValue(1,0,0,0);else{let t=[e[1],e[0],0],s=Math.acos(e[2]);this.fromAxisAngle(t,s)}return this},Ammo.btQuaternion.prototype.free=function(){},Ammo.btTransform.prototype.set=function(t,e){return this.setOrigin(t),this.setRotation(e),this},Ammo.btTransform.prototype.identity=function(){return this.setIdentity(),this},Ammo.btTransform.prototype.fromArray=function(t,e,s,i){let r=this.getOrigin();r.fromArray(t||[0,0,0],s||0),this.setOrigin(r);let o=this.getRotation();return o.fromArray(e||[0,0,0,1],i||0),this.setRotation(o),this},Ammo.btTransform.prototype.toArray=function(t,e){e=e||0,this.getOrigin().toArray(t,e),this.getRotation().toArray(t,e+3)},Ammo.btTransform.prototype.getPos=function(){return this.getOrigin().toArray()},Ammo.btTransform.prototype.getQuat=function(){return this.getRotation().toArray()},Ammo.btTransform.prototype.copy=function(t){return this.setOrigin(t.getOrigin()),this.setRotation(t.getRotation()),this},Ammo.btTransform.prototype.rotationFromAxis=function(t){let e=this.getRotation();return e.fromAxis(t),this.setRotation(e),this},Ammo.btTransform.prototype.free=function(){}}},i=2e3,r=500,o=50,a=100,n=50,l=50,m=20,h={bodyFull:14,body:8,joint:16,contact:8,ray:11,character:16,vehicle:72,solver:128},c=Math.PI,d=c/180,u=180/c,p=Number.EPSILON,y={todeg:u,torad:d,toFixed:(t,e=3)=>1*t.toFixed(e),clamp:(t,e,s)=>t=(t=t<e?e:t)>s?s:t,clampA:(t,e,s)=>Math.max(e,Math.min(s,t)),lerp:(t,e,s)=>(1-s)*t+s*e,damp:(t,e,s,i)=>y.lerp(t,e,1-Math.exp(-s*i)),nearAngle:(t,e,s=!1)=>e+Math.atan2(Math.sin(t-e),Math.cos(t-e))*(s?u:1),unwrapDeg:t=>t-360*Math.floor((t+180)/360),unwrapRad:t=>Math.atan2(Math.sin(t),Math.cos(t)),nearEquals:(t,e,s)=>Math.abs(t-e)<=s,autoSize:(t=[1,1,1],e="box")=>{1===t.length&&(t[1]=t[0]);let s=t[0],i=t[1];return"sphere"===e&&(t=[s,s,s]),"cylinder"!==e&&"wheel"!==e&&"capsule"!==e||(t=[s,i,s]),"cone"!==e&&"pyramid"!==e||(t=[s,i,s]),2===t.length&&(t[2]=t[0]),t},randomSign:()=>Math.random()<.5?-1:1,randSpread:t=>t*(.5-Math.random()),rand:(t=0,e=1)=>t+Math.random()*(e-t),randInt:(t,e)=>t+Math.floor(Math.random()*(e-t+1)),equalArray:(t,e)=>{let s=t.length;for(;s--;)if(t[s]!==e[s])return!1;return!0},composeMatrixArray:(t,e,s=[1,1,1])=>{const i=e[0],r=e[1],o=e[2],a=e[3],n=i+i,l=r+r,m=o+o,h=i*n,c=i*l,d=i*m,u=r*l,p=r*m,y=o*m,g=a*n,f=a*l,b=a*m,A=s[0],v=s[1],w=s[2];return[(1-(u+y))*A,(c+b)*A,(d-f)*A,0,(c-b)*v,(1-(h+y))*v,(p+g)*v,0,(d+f)*w,(p-g)*w,(1-(h+u))*w,0,t[0],t[1],t[2],1]},decomposeMatrixArray:t=>[t[12],t[13],t[14]],applyTransformArray:(t,e,s,i=[1,1,1])=>{const r=y.composeMatrixArray(e,s,i),o=t[0],a=t[1],n=t[2],l=1/(r[3]*o+r[7]*a+r[11]*n+r[15]);return[(r[0]*o+r[4]*a+r[8]*n+r[12])*l,(r[1]*o+r[5]*a+r[9]*n+r[13])*l,(r[2]*o+r[6]*a+r[10]*n+r[14])*l]},equalArray:(t,e)=>{let s=t.length;for(;s--;)if(t[s]!==e[s])return!1;return!0},lerpArray:(t,e,s)=>{if(0===s)return t;if(1===s)return e;let i=t.length,r=[];for(;i--;)r[i]=t[i],r[i]+=(e[i]-r[i])*s;return r},slerpQuatArray:(t,e,s)=>{if(0===s)return t;if(1===s)return e;let i=[...t];const r=t[0],o=t[1],a=t[2],n=t[3],l=e[0],m=e[1],h=e[2],c=e[3];let d=n*c+r*l+o*m+a*h;if(d<0?(i=[-l,-m,-h,-c],d=-d):i=[...e],d>=1)return t;const u=1-d*d;if(u<=p){const t=1-s;return i[3]=t*n+s*i[3],i[0]=t*r+s*i[0],i[1]=t*o+s*i[1],i[2]=t*a+s*i[2],y.quatNomalize(i)}const g=Math.sqrt(u),f=Math.atan2(g,d),b=Math.sin((1-s)*f)/g,A=Math.sin(s*f)/g;return i[3]=n*b+i[3]*A,i[0]=r*b+i[0]*A,i[1]=o*b+i[1]*A,i[2]=a*b+i[2]*A,i},toLocalQuatArray:(t=[0,0,0],e)=>{let s=y.quatFromEuler(t),i=y.quatInvert(e.quaternion.toArray());return y.quatMultiply(i,s)},quatFromEuler:(t=[0,0,0],e=!0)=>{const s=Math.cos,i=Math.sin,r=e?d:1,o=t[0]*r*.5,a=t[1]*r*.5,n=t[2]*r*.5,l=s(o),m=s(a),h=s(n),c=i(o),u=i(a),p=i(n);return[c*m*h+l*u*p,l*u*h-c*m*p,l*m*p+c*u*h,l*m*h-c*u*p]},quatFromAxis:(t=[0,0,0],e,s=!0)=>{const i=.5*e*(s?d:1),r=Math.sin(i);return[t[0]*r,t[1]*r,t[2]*r,Math.cos(i)]},quatNomalize:t=>{let e=y.lengthArray(t);return 0===e?[0,0,0,1]:(e=1/e,y.scaleArray(t,e,4))},quatInvert:t=>[-t[0],-t[1],-t[2],t[3]],quatMultiply:(t,e)=>{const s=t[0],i=t[1],r=t[2],o=t[3],a=e[0],n=e[1],l=e[2],m=e[3];return[s*m+o*a+i*l-r*n,i*m+o*n+r*a-s*l,r*m+o*l+s*n-i*a,o*m-s*a-i*n-r*l]},quatToAxis:t=>{let e=2*Math.acos(t[3]);const s=Math.sqrt(1-t[3]*t[3]);return s<1e-4?[1,0,0]:[t[0]/s,t[1]/s,t[2]/s,e]},eulerFromMatrix:t=>{const e=t[0],s=t[4],i=t[8];t[1];const r=t[5],o=t[9];t[2];const a=t[6],n=t[10];let l=[0,0,0];return l[1]=Math.asin(y.clamp(i,-1,1)),Math.abs(i)<.9999999?(l[0]=Math.atan2(-o,n),l[2]=Math.atan2(-s,e)):(l[0]=Math.atan2(a,r),l[2]=0),l},angleTo:(t,e)=>2*Math.acos(Math.abs(y.clamp(y.dotArray(t,e),-1,1))),lengthArray:t=>{let e=t.length,s=0;for(;e--;)s+=t[e]*t[e];return Math.sqrt(s)},dotArray:(t,e)=>{let s=t.length,i=0;for(;s--;)i+=t[s]*e[s];return i},addArray:(t,e,s)=>{s=s??t.length;let i=[];for(;s--;)i[s]=t[s]+e[s];return i},subArray:(t,e,s)=>{s=s??t.length;let i=[];for(;s--;)i[s]=t[s]-e[s];return i},mulArray:(t,e,s)=>{for(s=s??t.length;s--;)t[s]*=e;return t},divArray:(t,e,s)=>y.scaleArray(t,1/e,s),scaleArray:(t,e,s)=>{for(s=s??t.length;s--;)t[s]*=e;return t},fillArray(t,e,s,i){for(s=s||0,i=i??t.length;i--;)e[s+i]=t[i]},copyArray:(t,e)=>{},distanceArray:(t,e=[0,0,0])=>y.lengthArray(y.subArray(t,e)),getVolume:(t,e,s=null)=>{let i=1,r=e;switch(t){case"sphere":i=4*Math.PI*r[0]*r[0]*r[0]/3;break;case"cone":i=Math.PI*r[0]*(.5*r[1])*2;break;case"box":i=.5*r[0]*8*(.5*r[1])*(.5*r[2]);break;case"cylinder":i=Math.PI*r[0]*r[0]*(.5*r[1])*2;break;case"capsule":i=4*Math.PI*r[0]*r[0]*r[0]/3+Math.PI*r[0]*r[0]*(.5*r[1])*2;break;case"convex":case"mesh":i=y.getConvexVolume(s)}return i},getConvexVolume:t=>{let e,s=t.length/3,i=[0,0,0],r=[0,0,0];for(;s--;)e=3*s,t[e]<i[0]?i[0]=t[e]:t[e]>r[0]&&(r[0]=t[e]),t[e+1]<i[1]?i[1]=t[e+1]:t[e+1]>r[1]&&(r[1]=t[e+1]),t[e+2]<i[2]?i[2]=t[e+2]:t[e+2]>r[2]&&(r[2]=t[e+2]);let o=[r[0]-i[0],r[1]-i[1],r[2]-i[2]];return.5*o[0]*8*(.5*o[1])*(.5*o[2])},massFromDensity:(t,e)=>t*e,densityFromMass:(t,e)=>t/e,getIndex:t=>t.index&&t.index.array||null,getVertex:(t,e)=>{let s=t.attributes.position.array;if(e){s=t.clone().toNonIndexed().attributes.position.array}return s},reduce:t=>{},barycentric:(t,e)=>{},solve:(t,e)=>{}};class g{constructor(){this.id=0,this.list=[],this.type="item",this.Utils=null}reset(){let t=this.list.length;for(;t--;)this.dispose(this.list[t]);this.list=[],this.id=0}byName(t){return this.Utils.byName(t)}setName(t={}){let e=void 0!==t.name?t.name:this.type+this.id++;return t.id=this.remove(e,!0),t.name=e,e}addToWorld(t,e=-1){this.Utils.add(t),-1!==e?this.list[e]=t:this.list.push(t)}remove(t,e){let s=this.byName(t);return s?this.clear(s,e):-1}clear(t,e){let s=this.list.indexOf(t);return-1===s||e?this.list[s]=null:this.list.splice(s,1),this.dispose(t),s}dispose(t){null!==t&&this.Utils.remove(t)}vecZero(t,e,s){for(;s--;)t[e+s]=0}fillArray(t,e,s,i){for(s=s||0,i=i??t.length;i--;)e[s+i]=t[i]}arLength(t){let e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return e<.001&&(e=0),e}multiplyScalar(t,e,s){for(s=s??t.length;s--;)t[s]*=e}divideScalar(t,e,s){this.multiplyScalar(t,1/e,s)}add(t={}){}set(t={}){}step(t,e){}}class f extends g{constructor(){super(),this.Utils=s,this.type="ray",this.callback=new Ammo.ClosestRayResultCallback,this.t=new Ammo.btTransform}step(){const t=e.Ar,s=e.ArPos[this.type];e.reflow.ray=[];let i,r,o,a,n,l=this.list.length,m=this.callback;for(;l--;)r=s+l*h.ray,i=this.list[l],t[r]=0,m.set_m_collisionObject(null),a=i.getPoint(this.t),m.get_m_rayFromWorld().fromArray(a[0]),m.get_m_rayToWorld().fromArray(a[1]),m.set_m_collisionFilterGroup(i.group),m.set_m_collisionFilterMask(i.mask),m.set_m_closestHitFraction(i.precision),e.world.rayTest(m.get_m_rayFromWorld(),m.get_m_rayToWorld(),m),m.hasHit()&&(t[r]=1,n=m.get_m_hitPointWorld().toArray(),t[r+1]=y.distanceArray(a[0],n),t[r+2]=a[0][0],t[r+3]=a[0][1],t[r+4]=a[0][2],t[r+5]=n[0],t[r+6]=n[1],t[r+7]=n[2],m.get_m_hitNormalWorld().toArray(t,r+8),o=Ammo.castObject(m.get_m_collisionObject(),Ammo.btRigidBody).name,e.reflow.ray[l]=o)}add(t={}){this.setName(t);let e=new b(t);this.addToWorld(e,t.id)}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&(t.begin&&(e.begin=t.begin),t.end&&(e.end=t.end))}}class b{constructor(t={}){this.type="ray",this.name=t.name,this.parent=t.parent||"",this.begin=t.begin||[0,0,0],this.end=t.end||[0,0,1],this.precision=t.precision||1,this.group=void 0!==t.group||1,this.mask=void 0!==t.mask||-1}getPoint(t){if(this.parent){const e=s.byName(this.parent);if(e){e.getMotionState().getWorldTransform(t);const s=t.getOrigin().toArray(),i=t.getRotation().toArray();return[y.applyTransformArray(this.begin,s,i),y.applyTransformArray(this.end,s,i)]}}return[this.begin,this.end]}}class A extends g{constructor(){super(),this.Utils=s,this.type="body",this.itype="body",this.num=h[this.type],this.full=!1,this.v=new Ammo.btVector3,this.vv=new Ammo.btVector3,this.q=new Ammo.btQuaternion,this.t=new Ammo.btTransform,this.v1=new Ammo.btVector3,this.v2=new Ammo.btVector3,this.v3=new Ammo.btVector3}setFull(t){this.num=h[t?"bodyFull":"body"],this.full=t}step(){const t=e.Ar,s=e.ArPos[this.itype];let i,r,o,a,n=this.list.length;for(;n--;)i=this.list[n],r=s+n*this.num,i?(t[r]=2===i.getActivationState()?0:1,i.getMotionState().getWorldTransform(this.t),this.t.toArray(t,r+1),this.full&&(o=i.getLinearVelocity(),o.toArray(t,r+8),1===t[r]&&(t[r]=9.8*o.length()),a=i.getAngularVelocity(),a.toArray(t,r+11))):this.vecZero(t,r,this.num)}shape(t={}){let e,s,i,r=t.type||"box",o=t.size||[1,1,1];switch(r){case"plane":e=new Ammo.btStaticPlaneShape(this.v.fromArray(t.dir||[0,1,0]),.001),e.setLocalScaling(this.v.fromArray([1,1,1]));break;case"box":e=new Ammo.btBoxShape(this.v.set(.5*o[0],.5*o[1],.5*o[2]));break;case"particle":e=new Ammo.btSphereShape(t.pSize||.05);break;case"sphere":e=new Ammo.btSphereShape(o[0]);break;case"cone":e=new Ammo.btConeShape(o[0],o[1]);break;case"cylinder":e=new Ammo.btCylinderShape(this.v.set(o[0],.5*o[1],o[0]));break;case"capsule":e=new Ammo.btCapsuleShape(o[0],o[1]);break;case"convex":for(e=new Ammo.btConvexHullShape,s=Math.floor(t.v.length/3);s--;)i=3*s,e.addPoint(this.v.fromArray(t.v,i),!1);e.optimizeConvexHull(),e.recalcLocalAabb();break;case"mesh":let r=new Ammo.btTriangleMesh,a=!1,n=t.v,l=t.index||null,m=n.length;if(null!==l){for(m=n.length,s=0;s<m;s+=3)r.findOrAddVertex(this.v.set(n[s],n[s+1],n[s+2]),!1);for(m=l.length,s=0;s<m;s+=3)r.addTriangleIndices&&r.addTriangleIndices(l[s],l[s+1],l[s+2])}else for(s=0;s<m;s+=9)r.addTriangle(this.v1.set(n[s+0],n[s+1],n[s+2]),this.v2.set(n[s+3],n[s+4],n[s+5]),this.v3.set(n[s+6],n[s+7],n[s+8]),a);"solid"!==this.type&&Ammo.btGImpactMeshShape?(e=new Ammo.btGImpactMeshShape(r),e.setMargin(t.margin||.01)):e=new Ammo.btBvhTriangleMeshShape(r,!0,!0)}return e.setMargin&&e.setMargin(t.margin||1e-4),e.volume=y.getVolume(r,o,t.v),e}add(t={}){let s=this.setName(t),i=void 0!==t.flag?t.flag:"solid"===this.type?1:0,r=void 0!==t.group?t.group:"solid"===this.type?2:1,o=void 0!==t.mask?t.mask:-1;t.kinematic&&(i=2,r=4);let a=null;switch(t.type){case"null":o=0,a=this.shape({type:"sphere",size:[.01]});break;case"compound":let e,s;a=new Ammo.btCompoundShape,a.volume=0;for(var n=0;n<t.shapes.length;n++)e=t.shapes[n],this.t.fromArray(e.pos,e.quat),s=this.shape(e),a.volume+=s.volume,a.addChildShape(this.t,s);break;default:a=this.shape(t)}this.t.fromArray(t.pos,t.quat),this.v.set(0,0,0);let l=0;t.mass&&t.density&&delete t.density,t.density&&(l=y.massFromDensity(t.density||0,a.volume)),t.mass&&(l=t.mass),0!==l&&a.calculateLocalInertia(l,this.v);let m=new Ammo.btDefaultMotionState(this.t),h=new Ammo.btRigidBodyConstructionInfo(l,m,a,this.v),c=new Ammo.btRigidBody(h);c.setCollisionFlags(i),Ammo.destroy(h),c.mass=l,c.g=a,c.name=s,c.type=this.type,c.isKinematic=t.kinematic||!1,c.isGhost=!1,c.breakable=t.breakable||!1,c.breakable&&e.numBreak++,c.group=r,c.mask=o,c.first=!0,delete t.pos,delete t.quat,t.kinematic&&(t.neverSleep=!0,delete t.kinematic),this.addToWorld(c,t.id),this.set(t,c)}set(t={},s=null){null===s&&(s=this.byName(t.name)),null!==s&&(void 0!==t.kinematic&&(s.setCollisionFlags(t.kinematic?2:0),s.isKinematic=t.kinematic,s.isKinematic||s.setGravity(e.gravity)),void 0!==t.flag&&(s.setCollisionFlags(t.flag),s.isKinematic=2===t.flag),t.noGravity&&s.setGravity(this.v.fromArray([0,0,0])),(t.pos||t.quat)&&(t.pos&&t.quat||s.getMotionState().getWorldTransform(this.t),t.pos||(t.pos=this.t.getPos()),t.quat||(t.quat=this.t.getQuat()),this.t.fromArray(t.pos,t.quat),s.isKinematic?s.getMotionState().setWorldTransform(this.t):s.setWorldTransform(this.t)),void 0!==t.state&&s.setActivationState(t.state),(t.activate||t.wake)&&s.activate(),void 0!==t.neverSleep&&(t.neverSleep?(s.setSleepingThresholds(0,0),s.activate()):s.setSleepingThresholds(.8,1)),t.sleep&&s.setActivationState(2),void 0!==t.friction&&s.setFriction(t.friction),void 0!==t.restitution&&s.setRestitution(t.restitution),void 0!==t.rollingFriction&&s.setRollingFriction(t.rollingFriction),t.reset&&(s.setLinearVelocity(this.v.set(0,0,0)),s.setAngularVelocity(this.v.set(0,0,0))),s.isGhost||(void 0!==t.group&&(s.getBroadphaseProxy().set_m_collisionFilterGroup(t.group),s.group=t.group),void 0!==t.mask&&(s.getBroadphaseProxy().set_m_collisionFilterMask(t.mask),s.mask=t.mask),void 0!==t.damping&&s.setDamping(t.damping[0],t.damping[1]),void 0!==t.sleeping&&s.setSleepingThresholds(t.sleeping[0],t.sleeping[1])),"body"===s.type&&(void 0!==t.linearVelocity&&s.setLinearVelocity(this.v.fromArray(t.linearVelocity)),void 0!==t.angularVelocity&&s.setAngularVelocity(this.v.fromArray(t.angularVelocity))),void 0!==t.linearFactor&&s.setLinearFactor(this.v.fromArray(t.linearFactor)),void 0!==t.angularFactor&&s.setAngularFactor(this.v.fromArray(t.angularFactor)),void 0!==t.anisotropic&&s.setAnisotropicFriction(t.anisotropic[0],t.anisotropic[1]),void 0!==t.massProps&&s.setMassProps(t.massProps[0],t.massProps[1]),void 0!==t.ccdThreshold&&s.setCcdMotionThreshold(t.ccdThreshold),void 0!==t.ccdRadius&&s.setCcdSweptSphereRadius(t.ccdRadius),void 0!==t.selfGravity&&s.setGravity(this.v.fromArray(t.selfGravity)),void 0!==t.gravity&&s.setGravity(t.gravity?e.gravity:this.v.fromArray([0,0,0])),t.worldForce&&s.applyForce(this.v.fromArray(t.worldForce),this.v.fromArray(t.worldForce,3)),t.force&&s.applyForce(this.v.fromArray(t.force).divideScalar(e.substep)),t.torque&&s.applyTorque(this.v.fromArray(t.torque).divideScalar(e.substep)),t.impulse&&(t.impulseCenter?s.applyImpulse(this.v.fromArray(t.impulse),this.v2.fromArray(t.impulseCenter)):s.applyCentralImpulse(this.v.fromArray(t.impulse))))}}class v extends g{constructor(){super(),this.Utils=s,this.type="joint",this.t=new Ammo.btTransform,this.t1=new Ammo.btTransform,this.t2=new Ammo.btTransform,this.v1=new Ammo.btVector3,this.v2=new Ammo.btVector3,this.p1=new Ammo.btVector3,this.p2=new Ammo.btVector3,this.q1=new Ammo.btQuaternion,this.q2=new Ammo.btQuaternion}step(){if(16!==h.joint)return;const t=e.Ar,s=e.ArPos[this.type];let i,r,o=this.list.length;for(;o--;)i=this.list[o],r=s+o*h.joint,i.visible&&(this.t.copy(i.B1.getWorldTransform()).op_mul(i.formA).toArray(t,r),this.t.copy(i.B2.getWorldTransform()).op_mul(i.formB).toArray(t,r+7))}add(t={}){this.v;let e=this.setName(t),s=this.byName(t.b1),i=this.byName(t.b2);s&&"vehicle"===s.type&&(s=s.body),i&&"vehicle"===i.type&&(i=i.body);let r=this.v1.fromArray(t.pos1||[0,0,0]),o=this.v2.fromArray(t.pos2||[0,0,0]),a=this.q1.fromArray(t.quat1||[0,0,0,1]),n=this.q2.fromArray(t.quat2||[0,0,0,1]),l=this.p1.fromArray(t.axis1||[0,0,1]),m=this.p2.fromArray(t.axis2||[0,0,1]);t.quat1||a.fromAxis(l),t.quat2||n.fromAxis(m);const h=t.useA||!0,c=(new Ammo.btTransform).set(r,a),d=(new Ammo.btTransform).set(o,n);let u,p=t.mode||"revolute";switch("d6"!==p&&"universal"!==p&&"dof"!==p||(p="generic"),"slider"!==p&&"cylindrical"!==p||(p="prismatic"),"joint_p2p"===p&&(p="spherical"),"conetwist"===p&&(p="ragdoll"),p){case"spherical":u=new Ammo.btPoint2PointConstraint(s,i,r,o),t.strength&&u.get_m_setting().set_m_tau(t.strength),t.damping&&u.get_m_setting().set_m_damping(t.damping),t.impulse&&u.get_m_setting().set_m_impulseClamp(t.impulse);break;case"distance":t.lm&&(r.setValue(r.x()+t.lm[0],r.y(),r.z()),o.setValue(o.x()+t.lm[1],o.y(),o.z())),u=new Ammo.btPoint2PointConstraint(s,i,r,o);break;case"hinge2":u=new Ammo.btHinge2Constraint(s,i,r,l,m),u.setAxis(this.v1.fromArray([0,0,1]));break;case"hinge":case"revolute":u=new Ammo.btHingeConstraint(s,i,c,d,h),u.setAxis(l);break;case"prismatic":u=new Ammo.btSliderConstraint(s,i,c,d,h);break;case"ragdoll":u=new Ammo.btConeTwistConstraint(s,i,c,d);break;case"generic":u=new Ammo.btGeneric6DofSpringConstraint(s,i,c,d,h);break;case"fixe":u=new Ammo.btFixedConstraint(s,i,c,d);break;case"gear":u=new Ammo.btGearConstraint(s,i,l,m,t.ratio||1)}u.name=e,u.mode=p,u.type=this.type,u.B1=s,u.B2=i,u.formA=c,u.formB=d,u.visible=!1,u.collision=t.collision||!1,this.set(t,u),this.addToWorld(u,t.id)}set(t={},e=null){if(null===e&&(e=this.byName(t.name)),null===e)return;let s,i,r,o;void 0!==t.visible&&(e.visible=t.visible),t.breaking&&e.setBreakingImpulseThreshold&&e.setBreakingImpulseThreshold(t.breaking),t.iteration&&e.setOverrideNumSolverIterations&&e.setOverrideNumSolverIterations(t.iteration);const a=["x","y","z","rx","ry","rz"];switch(e.mode){case"prismatic":t.lm&&(e.setLowerLinLimit(t.lm[0]),e.setUpperLinLimit(t.lm[1])),t.lmr&&(e.setLowerAngLimit(t.lmr[0]*d),e.setUpperAngLimit(t.lmr[1]*d)),t.motor&&(e.setTargetLinMotorVelocity(t.motor[0]),e.setMaxLinMotorForce(t.motor[1])),t.amotor&&(e.setTargetAngMotorVelocity(t.amotor[0]*d),e.setMaxAngMotorForce(t.amotor[1]));break;case"hinge":case"revolute":t.lm&&e.setLimit(t.lm[0]*d,t.lm[1]*d,t.lm[2]||.9,t.lm[3]||.3,t.lm[4]||1),t.motor&&e.enableAngularMotor(!0,t.motor[0]*d,t.motor[1]);break;case"distance":break;case"generic":if(t.motor){s=t.motor.length;let o=!1;for(;s--;)i=t.motor[s],"rx"===i[0]?r=e.getRotationalLimitMotor(0):"ry"===i[0]?r=e.getRotationalLimitMotor(1):"rz"===i[0]?r=e.getRotationalLimitMotor(2):(r=getTranslationalLimitMotor(),o=!0),r&&(o||(r.set_m_enableMotor(!0),r.set_m_targetVelocity(-i[1]*d),r.set_m_maxMotorForce(i[2])))}if(t.lm){for(r=[[0,0,0],[0,0,0],[0,0,0],[0,0,0]],s=t.lm.length;s--;)i=t.lm[s],"rx"===i[0]&&(r[0][0]=-i[2]*d,r[1][0]=-i[1]*d),"ry"===i[0]&&(r[0][1]=-i[2]*d,r[1][1]=-i[1]*d),"rz"===i[0]&&(r[0][2]=-i[2]*d,r[1][2]=-i[1]*d),"x"===i[0]&&(r[2][0]=i[1],r[3][0]=i[2]),"y"===i[0]&&(r[2][1]=i[1],r[3][1]=i[2]),"z"===i[0]&&(r[2][2]=i[1],r[3][2]=i[2]),i.length>3&&(o=a.indexOf(i[0]),e.enableSpring(o,0!==i[3]),e.setStiffness(o,1/i[3]||0),e.setDamping(o,1/i[4]||0));e.setAngularLowerLimit(this.v1.fromArray(r[0])),e.setAngularUpperLimit(this.v1.fromArray(r[1])),e.setLinearLowerLimit(this.v1.fromArray(r[2])),e.setLinearUpperLimit(this.v1.fromArray(r[3]))}}}}class w extends g{constructor(){super(),this.Utils=s,this.type="contact",this.cb=new Ammo.ConcreteContactResultCallback}step(){const t=e.Ar,s=e.ArPos[this.type];let i,r,o,a=this.list.length;for(;a--;)o=0,i=this.list[a],r=s+a*h.contact,this.cb.addSingleResult=function(){o=1},null!==i.b2?e.world.contactPairTest(i.b1,i.b2,this.cb):e.world.contactTest(i.b1,this.cb),t[r]=o}add(t={}){this.setName(t),t.b1=this.byName(t.b1),t.b2=this.byName(t.b2);let e=new _(t);this.addToWorld(e,t.id)}}class _{constructor(t={}){this.type="contact",this.name=t.name,this.b1=t.b1||null,this.b2=t.b2||null,this.ignore=t.ignore||[],this.result={hit:!1,point:[0,0,0],normal:[0,0,0],distance:0}}update(){}}class M extends g{constructor(){super(),this.type="vehicle",this.Utils=s,this.trans=new Ammo.btTransform}step(){const t=e.Ar,s=e.ArPos[this.type];let i,r=this.list.length;for(;r--;)i=s+r*h.vehicle,this.list[r].step(t,i,this.trans)}add(t){this.setName(t);let e=new S(t);this.addToWorld(e,t.id)}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&e.set(t)}}class S{constructor(t){this.type="vehicle",this.name=t.name,this.enable=!1,this.numWheel=t.numWheel||4,this.wheelsPosition=t.wheelsPosition,this.radius=t.radius,this.radiusBack=t.radiusBack,this.deep=t.deep,this.deepBack=t.deepBack,this.massCenter=t.massCenter||[0,.55,1.594],this.chassisPos=t.chassisPos||[0,.83,0],this.chassis=null,this.body=null,this.steering=0,this.breaking=0,this.motor=0,this.gearRatio=[-1,0,2.3,1.8,1.3,.9,.5],this.key=[0,0,0,0,0,0,0,0],this.limitAngular=[1,1,1],this.transforms=[],this.wheelBody=[],this.wheelJoint=[],this.wheelRadius=[],this.isRay=!0,this.tr=new Ammo.btTransform,this.tmpT=new Ammo.btTransform,this.tmpV=new Ammo.btVector3,this.data={mass:t.mass||2e3,incSteering:t.incSteering||2,maxSteering:t.maxSteering||24,wMass:1,wWidth:.25,engine:1e3,acceleration:10,breaking:100,pos:[0,0,0],quat:[0,0,0,1],masscenter:[0,-.6,0],friction:.6,restitution:.1,rolling:0,autoSuspension:!1,compValue:.2,dampValue:.3,s_stiffness:t.s_stiffness||20,s_damping:t.s_damping||4.4,s_compression:t.s_compression||2.3,s_travel:t.s_travel||.4,s_force:6e3,w_friction:10.5,w_roll:.001};let e=Math.round(this.data.mass/this.numWheel);t.s_compression||(this.data.s_compression=.6*this.data.s_damping),t.s_force||(this.data.s_force=25*e),this.init(t)}init(t){this.size=t.size||[1.7,1,5];const s=this.data;let i=new Ammo.btTransform,r=new Ammo.btVector3,o=new Ammo.btVector3,a=new Ammo.btVector3,n=new Ammo.btVector3;s.mass=void 0===t.mass?800:t.mass,s.pos=void 0===t.pos?[0,0,0]:t.pos,s.quat=void 0===t.quat?[0,0,0,1]:t.quat,this.chassisShape=t.chassisShape?e.bodyRef.shape(t.chassisShape):new Ammo.btBoxShape(r.set(.5*this.size[0],.5*this.size[1],.5*this.size[2])),r.fromArray(this.massCenter),i.setIdentity(),i.setOrigin(r);const l=new Ammo.btCompoundShape;l.addChildShape(i,this.chassisShape),this.startPose=(new Ammo.btTransform).fromArray(t.pos||[0,1,0],t.quat||[0,0,0,1]),r.setValue(0,0,0),l.calculateLocalInertia(s.mass,r);var m=new Ammo.btDefaultMotionState(this.startPose),h=new Ammo.btRigidBodyConstructionInfo(s.mass,m,l,r);this.body=new Ammo.btRigidBody(h),this.body.name=this.name,this.body.setActivationState(4),Ammo.destroy(h);const c=new Ammo.btVehicleTuning,d=new Ammo.btDefaultVehicleRaycaster(e.world);this.chassis=new Ammo.btRaycastVehicle(c,this.body,d),this.chassis.setCoordinateSystem(0,1,2);const u=this.numWheel;for(let l=0;l<u;l++){let d=l<2;if(o.fromArray(this.wheelsPosition[l]),a.setValue(0,-1,0),n.setValue(-1,0,0),this.isRay)this.chassis.addWheel(o,a,n,1,d?this.radius:this.radiusBack,c,d),this.chassis.setBrake(t.breaking||100,l);else{i.identity(),i.setOrigin(o),a.setValue(s.wWidth*e.invScale,radius,radius),shape=new Ammo.btCylinderShape(a),r.setValue(0,0,0),shape.calculateLocalInertia(s.wMass,r);m=new Ammo.btDefaultMotionState(i),h=new Ammo.btRigidBodyConstructionInfo(s.wMass,m,shape,r);var p=new Ammo.btRigidBody(h);p.setFriction(1),p.setActivationState(4),e.world.addRigidBody(p,1,-1),this.wheelBody[l]=p;var y=new Ammo.btHingeConstraint(this.body,p,o,r,a,n,!1);e.world.addConstraint(y,!1)}}this.setData(t),i.free(),r.free(),o.free(),a.free(),n.free(),e.world.addAction(this.chassis),e.world.addRigidBody(this.body)}step(t,e,s){this.drive(),t[e]=this.chassis.getCurrentSpeedKmHour(),this.body.getMotionState().getWorldTransform(s),s.toArray(t,e+1),s=s.inverse();for(var i,r,o=this.numWheel;o--;)this.chassis.updateWheelTransform(o,!0),(r=this.chassis.getWheelTransformWS(o)).mult(s,r),i=8*(o+1),r.toArray(t,e+i+1),0===o&&(t[e+i]=this.chassis.getWheelInfo(0).get_m_steering()),1===o&&(t[e+i]=this.chassis.getWheelInfo(1).get_m_steering()),2===o&&(t[e+i]=this.steering)}set(t){t.key&&(this.key=t.key),(t.pos||t.quat)&&(this.body.getMotionState().getWorldTransform(this.tr),t.pos&&this.tr.setOrigin(this.tr.getOrigin().fromArray(t.pos)),t.quat&&this.tr.setRotation(this.tr.getRotation().fromArray(t.quat)),this.body.setWorldTransform(this.tr))}setMass(t){var e=this.tmpV;this.data.mass=t,e.setValue(0,0,0),this.body.getCollisionShape().calculateLocalInertia(this.data.mass,e),this.body.setMassProps(t,e),this.body.updateInertiaTensor(),e.free()}setPosition(){this.steering=0,this.breaking=0,this.motor=0,this.tmpT.identity().fromArray(this.data.pos.concat(this.data.quat));var t=this.tmpV.set(0,0,0);this.body.setAngularVelocity(t),this.body.setLinearVelocity(t),this.body.setWorldTransform(this.tmpT),this.chassis.resetSuspension();for(var e=this.numWheel;e--;)this.chassis.updateWheelTransform(e,!0)}drive(){if(!this.enable)return;const t=this.data,s=e.key;let i,r;if(0===s[0]?this.steering*=.9:this.steering-=t.incSteering*s[0],this.steering=y.clamp(this.steering,-t.maxSteering,t.maxSteering),0===s[1]?(this.motor=0,this.breaking=t.breaking):(this.motor-=t.acceleration*s[1],this.breaking=0),this.motor=y.clamp(this.motor,-t.engine,t.engine),this.wheelSide=this.wheelsPosition[1][0],this.wheelBase=2*this.wheelsPosition[1][2],this.numWheel>3){let t=this.wheelBase/Math.tan(this.steering*d);i=Math.atan2(this.wheelBase,this.wheelSide+t),r=Math.atan2(this.wheelBase,-this.wheelSide+t),t<0&&(i-=Math.PI,r-=Math.PI)}let o=this.numWheel;for(;o--;)this.numWheel<4?0===o&&this.chassis.setSteeringValue(this.steering*d,o):(0===o&&this.chassis.setSteeringValue(r,o),1===o&&this.chassis.setSteeringValue(i,o)),this.chassis.applyEngineForce(this.motor,o),this.chassis.setBrake(this.breaking,o);if(this.motor<1){var a=this.body.getAngularVelocity();a.multiplyArray(this.limitAngular),this.body.setAngularVelocity(a)}}clear(){this.body=null,this.chassis=null}setData(t){var e=this.data;for(var s in void 0!==t.mass&&t.mass!==e.mass&&this.setMass(t.mass),t)void 0!==e[s]&&(e[s]=t[s]);this.body.setFriction(e.friction),this.body.setRestitution(e.restitution),this.body.setRollingFriction(e.rolling),void 0!==t.damping&&this.body.setDamping(t.damping[0],t.damping[1]),void 0!==t.limitAngular&&(this.limitAngular=t.limitAngular);var i=new Ammo.btVector3;if(void 0!==t.linearFactor&&this.body.setLinearFactor(i.fromArray(t.linearFactor)),void 0!==t.angularFactor&&this.body.setAngularFactor(i.fromArray(t.angularFactor)),i.free(),e.autoSuspension){var r=Math.sqrt(e.s_stiffness);e.s_compression=2*e.compValue*r,e.s_damping=2*e.dampValue*r,console.log(r,e.s_damping,e.s_compression)}for(var o,a=this.numWheel;a--;)(o=this.chassis.getWheelInfo(a)).set_m_suspensionStiffness(e.s_stiffness),o.set_m_wheelsDampingCompression(e.s_compression),o.set_m_wheelsDampingRelaxation(e.s_damping),o.set_m_maxSuspensionTravelCm(100*e.s_travel),o.set_m_suspensionRestLength1(.5*e.s_travel),o.set_m_maxSuspensionForce(e.s_force),o.set_m_rollInfluence(e.w_roll),o.set_m_frictionSlip(e.w_friction),o.set_m_wheelsRadius(a<2?this.radius:this.radiusBack);t.reset&&this.setPosition()}get(){self.postMessage({m:"carData",o:this.data})}release(){e.world.removeAction(this.chassis),e.world.removeRigidBody(this.body),Ammo.destroy(this.chassis),Ammo.destroy(this.body)}}class k extends g{constructor(){super(),this.type="terrain",this.Utils=s}add(t){this.setName(t);let e=new x(t);this.addToWorld(e,t.id)}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&e.set(t)}}class x{constructor(t){this.type="terrain",this.name=t.name,this.needUpdate=!1,this.heightField=null,this.t=new Ammo.btTransform,this.data=null,this.init(t)}init(t){const e=t.size,s=[e[0]/(t.sample[0]-1),e[2]/(t.sample[1]-1)];this.fullSample=[t.sample[0],t.sample[1]],this.setData(t),this.update();let i=void 0===t.margin?.02:t.margin,r=void 0===t.heightScale?1:t.heightScale,o=void 0===t.upAxis?1:t.upAxis,a=new Ammo.btHeightfieldTerrainShape(t.sample[0],t.sample[1],this.data,r,2*-e[1],2*e[1],o,"PHY_FLOAT",!1),n=new Ammo.btVector3(s[0],1,s[1]);a.setLocalScaling(n),a.setMargin(i);let l=void 0===t.mass?0:t.mass,m=void 0===t.friction?.5:t.friction,h=void 0===t.restitution?0:t.restitution,c=void 0===t.flag?1:t.flag;this.group=void 0!==t.group?t.group:2,this.mask=void 0!==t.mask?t.mask:-1,this.t.fromArray(t.pos,t.quat),n.set(0,0,0);let d=new Ammo.btDefaultMotionState(this.t),u=new Ammo.btRigidBodyConstructionInfo(l,d,a,n);u.set_m_friction(m),u.set_m_restitution(h),this.body=new Ammo.btRigidBody(u),this.body.setCollisionFlags(c)}setData(t){this.tmpData=t.heightData,this.nDataBytes=this.tmpData.length*this.tmpData.BYTES_PER_ELEMENT,this.needsUpdate=!0}update(){this.needsUpdate&&(this.malloc(),this.needsUpdate=!1,this.tmpData=null)}malloc(){null===this.data&&(this.data=Ammo._malloc(this.nDataBytes));let t=this.tmpData.length,e=0,s=0;for(;t--;)Ammo.HEAPF32[this.data+s>>2]=this.tmpData[e],e++,s+=4}release(){e.world.removeCollisionObject(this.body),Ammo.destroy(this.body),this.body=null,this.data=null,this.tmpData=null,this.dataHeap=null}set(t){t.heightData&&(this.setData(t),this.update())}}class V extends A{constructor(){super(),this.itype="character",this.num=h.character}add(t={}){t.type="capsule",super.add(t)}remove(t={}){}dispose(t){}}let T;self.onmessage=function(t){it.message(t)};let C,R,F=!1,B=!1,P=!0,I=!1;const W="undefined"==typeof performance?Date:performance,q={tmp:0,n:0,dt:0,fps:0};let L,D,N,O,z,j,U,E=1/60,Q=16.67,G=4,H=!0,K=2,Y=0,X=0,Z=!0,J=null,$=null,tt=null,et={},st="";class it{static test(){}static message(t){let s=t.data;s.Ar&&(e.Ar=s.Ar),s.flow&&(et=s.flow),s.m&&it[s.m](s.o)}static post(t,e){R?self.postMessage(t,e):C({data:t})}static init(t={}){R=!0,I=t.isBuffer||!1,void 0!==t.fps&&(E=1/t.fps),void 0!==t.substep&&(G=t.substep),t.message&&(C=t.message,R=!1,I=!1),t.blob&&importScripts(t.blob),Ammo().then((t=>{self.Ammo=t,s.extends(),it.initItems(),it.post({m:"ready",o:{}})}))}static set(t={}){e.ArPos=t.ArPos||function(t,e=!1){let s={},c={body:i*(e?h.bodyFull:h.body),joint:r*h.joint,ray:a*h.ray,contact:o*h.contact,character:n*h.character};"PHYSX"!==t&&"AMMO"!==t||(c.vehicle=l*h.vehicle),"PHYSX"===t&&(c.solver=m*h.solver),"HAVOK"!==t&&"RAPIER"!==t||(h.joint=0);let d=0;for(let t in c)s[t]=d,d+=c[t];return s.total=d,s}("AMMO",t.full),T.body.setFull(t.full),B=t.outsideStep||!1,F=t.isTimeout||!1,E=1/(t.fps||60),Q=y.toFixed(1e3*E,2),G=t.substep||1,H=void 0===t.fixe||t.fixe,K=t.broadphase||2,e.substep=G,P=void 0===t.soft||t.soft,e.gravity=(new Ammo.btVector3).fromArray(t.gravity||[0,-9.8,0]),t.penetration&&(tt=t.penetration),null===e.world&&it.start()}static setGravity(t){e.gravity.fromArray(t.gravity),e.world&&e.world.setGravity(e.gravity)}static start(){null===e.world&&(e.Ar=new Float32Array(e.ArPos.total),it.initWorld()),Z=!1,L=!1,X=0,D=0,B||(F?($&&clearTimeout($),$=setTimeout(it.step,0)):J=setInterval(it.step,Q))}static initWorld(){switch(N=new Ammo.btSequentialImpulseConstraintSolver,O=P?new Ammo.btDefaultSoftBodySolver:null,z=P?new Ammo.btSoftBodyRigidBodyCollisionConfiguration:new Ammo.btDefaultCollisionConfiguration,j=new Ammo.btCollisionDispatcher(z),K){case 1:let t=1e3;U=new Ammo.btAxisSweep3(new Ammo.btVector3(-t,-t,-t),new Ammo.btVector3(t,t,t),4096);break;case 2:U=new Ammo.btDbvtBroadphase}(e.world=P?new Ammo.btSoftRigidDynamicsWorld(j,U,N,z,O):new Ammo.btDiscreteDynamicsWorld(j,U,N,z),e.world.setGravity(e.gravity),P)&&e.world.getWorldInfo().set_m_gravity(e.gravity);tt&&e.world.getDispatchInfo().set_m_allowedCcdPenetration(tt)}static controle(t){t!==st&&(this.enable(st,!1),st=t,this.enable(st,!0))}static enable(t,e){if(""===t)return;let s=it.byName(t);null!==s?s.enable=e:st=""}static dispatch(){if(e.key=et.key,et.remove)for(;et.remove.length>0;)this.remove(et.remove.shift());if(et.add)for(;et.add.length>0;)this.add(et.add.shift());if(et.tmp)for(;et.tmp.length>0;)this.change(et.tmp.shift());this.controle(et.current)}static poststep(){if(!Z&&(D=1,this.dispatch(),!B&&F)){$&&clearTimeout($);let t=Q-(W.now()-X);t<0&&(t=0),$=setTimeout(it.step,t)}}static step(t){if(L&&it.endReset(),Z||D>=2)return;D=2,Y=t||W.now(),e.delta=.001*(Y-X),X=Y;let s=G,i=H?E/G:e.delta/G;H?e.world.stepSimulation(E,s,i):e.world.stepSimulation(e.delta,s,i),it.stepItems(),e.numBreak>0&&it.stepBreak(),Y-1e3>q.tmp&&(q.tmp=Y,e.reflow.stat.fps=q.n,q.n=0),q.n++,e.reflow.stat.delta=e.delta,I?it.post({m:"step",reflow:e.reflow,Ar:e.Ar},[e.Ar.buffer]):it.post({m:"step",reflow:e.reflow,Ar:e.Ar}),e.reflow.point={}}static byName(t){return s.byName(t)}static reset(){L=!0}static endReset(){it.stop(),it.resetItems(),it.clearReFlow(),e.numBreak=0,Ammo.destroy(e.world),Ammo.destroy(N),P&&Ammo.destroy(O),Ammo.destroy(z),Ammo.destroy(j),Ammo.destroy(U),e.world=null,st="",s.clear(),it.post({m:"resetCallback",o:{}})}static stop(){Z=!0,B||($&&clearTimeout($),J&&clearInterval(J),J=null,$=null)}static pause(t){let e=t.value;e!==Z&&(e?this.stop():this.start())}static clearReFlow(){e.reflow={ray:[],stat:{fps:0,delta:0},point:{}}}static stepBreak(){let t,s,i,r,o,a,n;for(let l=0,m=j.getNumManifolds();l<m;l++)if(t=j.getManifoldByIndexInternal(l),a=Ammo.castObject(t.getBody0(),Ammo.btRigidBody),n=Ammo.castObject(t.getBody1(),Ammo.btRigidBody),r=a.name,o=n.name,(a.breakable||n.breakable)&&!a.breakable&&n.breakable)for(let m=0,h=t.getNumContacts();m<h;m++)if(s=t.getContactPoint(m),i=y.toFixed(s.getDistance(),3),i<-.01){let t={distance:i,pos:s.get_m_positionWorldOnB().toArray(),normal:s.get_m_normalWorldOnB().toArray(),impulse:20*s.getAppliedImpulse(),v1:it.getVelocity(a),v2:it.getVelocity(n)};e.reflow.point[r+"_"+o+"_"+l+"_"+m]={b1:r,b2:o,hit:i<0,...t}}}static getVelocity(t){if(t&&t.breakable){return[...t.getLinearVelocity().toArray(),...t.getAngularVelocity().toArray()]}return[0,0,0,0,0,0]}static initItems(){T={ray:new f,body:new A,solid:new rt,joint:new v,contact:new w,character:new V,vehicle:new M,terrain:new k},e.bodyRef=T.body,e.byName=it.byName}static resetItems(){Object.values(T).forEach((t=>t.reset()))}static stepItems(){Object.values(T).forEach((t=>t.step()))}static add(t={}){let e=function(t){switch(t.type){case"plane":case"box":case"sphere":case"highSphere":case"cylinder":case"stair":case"particle":case"cone":case"capsule":case"mesh":case"convex":case"compound":case"null":return t.mass||t.density||t.kinematic?"body":"solid";case"generic":case"hinge":case"slider":case"spherical":case"fixe":case"dof":case"d6":case"ragdoll":case"universal":case"cylindrical":case"distance":case"revolute":case"prismatic":return"joint";default:return t.type}}(t);T[e].add(t)}static remove(t={}){let e=this.byName(t.name);null!==e&&T[e.type].clear(e)}static change(t={}){let e=this.byName(t.name);null!==e&&T[e.type].set(t,e)}}class rt extends A{constructor(){super(),this.type="solid"}step(){}}export{it as engine};
